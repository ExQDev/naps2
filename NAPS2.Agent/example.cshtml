@{
    ViewBag.Title = "Demo Page";
}


<button type="button" onclick="scanImage();" class="btn btn-primary btn-lg">Just Scan and close</button>
<button type="button" onclick="batchScan();" class="btn btn-primary btn-lg">Batch scan</button>
<button type="button" onclick="openNaps();" class="btn btn-primary btn-lg">Open NAPS</button>
<button type="button" onclick="getNAPSVer();" class="btn btn-primary btn-lg">Get NAPS is connected</button>
<button type="button" onclick="openAndScan();" class="btn btn-primary btn-lg">Open, Scan, Leave open</button>
<br />





<div id="selectedFiles" class="row" style="padding: 3px"></div>

<div class="modal fade scandetail" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div style="max-height:1200px;overflow:scroll;">
                <canvas id="myCanvas"></canvas>
            </div>
        </div>
    </div>
</div>


<div class="modal fade dalert" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                Connection Failed
            </div>
            <div class="modal-body">
                No Scan app application found in your machine please download,install and open first then refresh the browser.
                <a href="~/SrcFile/Scan_App_SetUp.msi" download>Download Files</a>
            </div>
        </div>
    </div>
</div>

@section Scripts
{
    <script type="text/javascript">
        var i = 0;
        var selDiv = "";
        var storedFiles = [];

        $(document).ready(function () {
            selDiv = $("#selectedFiles");
            $("body").on("click", ".selFile", editFiles);
        });

        function dataURLtoFile(dataurl, filename) {

            var arr = dataurl.split(','),
                mime = arr[0].match(/:(.*?);/)[1],
                bstr = atob(arr[1]),
                n = bstr.length,
                u8arr = new Uint8Array(n);

            while (n--) {
                u8arr[n] = bstr.charCodeAt(n);
            }

            return new File([u8arr], filename, { type: mime });
        }

        var processImg = function (data) {
            i++;

            var f = null;

            if (typeof data === 'string') {
                f = dataURLtoFile("data:image/png;base64,"+data, "File" + i)
                //var html = "<div class=\"col-sm-2 text-center\" style=\"border: 1px solid black; margin-left: 2px;\"><img height=\"200px\" width=\"200px\" src=\"data:image/png;base64," + data + "\" class='selFile' title='Click to remove'><br/>" + i + "</div>";
                //selDiv.append(html);
            } else {
                f = data;
            }
            f.name = "File" + i;

            storedFiles.push(f);

            var reader = new FileReader();

            reader.onload = function (e) {
                var html = "<div class=\"col-sm-2 text-center\" style=\"border: 1px solid black; margin-left: 2px;\"><img height=\"200px\" width=\"200px\" src=\"" + e.target.result + "\" data-file='" + f.name + "' class='selFile' title='Click to remove'><br/>" + i + "</div>";
                selDiv.append(html);

            }
            reader.readAsDataURL(f);
        }

        var start = function () {

            var wsImpl = window.WebSocket || window.MozWebSocket;

            window.ws = new wsImpl('ws://localhost:1488/');
            ws.onmessage = function (e) {
                if (typeof e.data === "string") {
                    var m = JSON.parse(e.data);
                    console.log(m)
                    switch (m.code.toString()) {
                        case "2201":
                            alert(m.message);
                            break;
                        case "0300":
                            alert("Error: " + m.message);
                            break;
                        case "0220":
                            //alert("Scan started")
                            break;
                        case "0222":
                            //alert("Scan ended");
                            break;
                        case "0211":
                            processImg(m.base64img);
                            break;
                        default:
                            console.log(message);
                            break;

                    }
                    //IF Received Data is String
                }
                else if (e.data instanceof ArrayBuffer) {
                   //IF Received Data is ArrayBuffer
                }
                else if (e.data instanceof Blob) {

                    processImg(e.data)
                }
            };
            ws.onopen = function () {
                console.log('opened')
                //Do whatever u want when connected succesfully
            };
            ws.onclose = function () {
                $('.dalert').modal('show');
            };
        }
        window.onload = start;

        function scanImage() {
            var msg = {
                code: "1100"
            };
            ws.send(JSON.stringify(msg));
        };
        function batchScan() {
            var msg = {
                code: "1103"
            };
            ws.send(JSON.stringify(msg));
        };
        function openAndScan() {
            var msg = {
                code: "1101"
            };
            ws.send(JSON.stringify(msg));
        };
        function openNaps() {
            var msg = {
                code: "0111"
            };
            ws.send(JSON.stringify(msg));
        };
        function getNAPSVer() {
            var msg = {
                code: "3000"
            };
            if (!ws) { alert ("not connected") }
            ws.send(JSON.stringify(msg));
        };

        function editFiles(e) {
            var file = $(this).data("file");
            for (var i = 0; i < storedFiles.length; i++) {
                if (storedFiles[i].name === file) {
                    $('.scandetail').modal('show');
                    var c = document.getElementById("myCanvas");
                    var ctx = c.getContext("2d");
                    var img = new Image();
                    img.src = window.URL.createObjectURL(storedFiles[i]);
                    img.onload = function () {
                        c.width = img.width ;
                        c.height = img.height;
                        ctx.drawImage(img, 0, 0, img.width, img.height);
                    }
                    break;

                }
            }
        };

     </script>
}